<template page>
  <link rel="stylesheet" href="./css/style.css" />
  <h1 id="heading" class="center">PackageManager</h1>
  <div class="center">
    <s-search id="search" placeholder="搜索" on:input="search = $event.target.value">
      <s-icon name="search" slot="start"></s-icon>
      <s-icon-button slot="end" on:click="clearSearch($event)">
        <s-icon name="close"></s-icon>
      </s-icon-button>
    </s-search>
    <p>搜索: {{search}}</p>
  </div>
  <div id="language" class="center flex">
    <s-chip clickable="true" checked="true" type="outlined" language="all" on:change="reloadFilter($event)">
      全部
    </s-chip>
    <x-fill :value="languages">
      <s-chip clickable="true" type="outlined" attr:language="$data.name" on:change="$host.reloadFilter($event)">
        <img attr:src="$data.logo" attr:alt="$data.name" class="logo-small" />
        {{$data.name}}
        <s-icon-button slot="action" on:click="$host.openlink($event,$data.official)">
          <s-icon name="home"></s-icon>
        </s-icon-button>
      </s-chip>
    </x-fill>
  </div>
  <div id="manager" class="center flex">
    <x-fill :value="managers" name="managerItem"></x-fill>
  </div>
  <template name="managerItem">
    <div style="display: inline-block;">
      <x-if :value="$host.shouldShow($data)">
        <s-tooltip>
          <s-chip clickable="false" type="outlined" slot="trigger">
            <img attr:src="$data.logo" attr:alt="$data.name" class="logo-small" />
            {{$data.name}}
            <s-icon-button slot="action" on:click="$host.openlink($event,$data.official)">
              <s-icon name="home"></s-icon>
            </s-icon-button>
          </s-chip>
          {{$data.languages.join(',')}}
        </s-tooltip>
      </x-if>
    </div>
  </template>
  <script>
    export default ({ query }) => {
      return {
        data: {
          search: '',
          languages: [],
          managers: []
        },
        watch: {
          search(val) {
            this.refresh();
          }
        },
        ready() {
          this.initLanguages();
          this.initManagers();
        },
        proto: {
          reloadFilter(event) {
            const ele = $(event.target);
            if (ele.attr('language') === 'all') {
              if (ele.attr('checked') === 'true') {
                // 全选时清除其他选项
                this.shadow.all(`#language s-chip[language]:not([language=all])`).forEach(chip => {
                  chip.attr('checked', 'false');
                });
              } else {
                // 取消全选时选中其他选项
                this.shadow.all(`#language s-chip[language]:not([language=all])`).forEach(chip => {
                  chip.attr('checked', 'true');
                });
              }
            } else {
              if (this.shadow.$(`#language s-chip[checked=true][language]:not([language=all])`)) {
                // 有选中时取消全选
                this.shadow.$(`#language s-chip[language=all]`).attr('checked', 'false');
              } else {
                // 无选中时选中全选
                this.shadow.$(`#language s-chip[language=all]`).attr('checked', 'true');
              }
            }
            console.log('选中语言：', this.shadow.all(`#language s-chip[checked=true]`).map(chip => chip.attr('language')));
            this.refresh();
          },
          initLanguages() {
            fetch('./data/languages.json')
              .then(res => res.json())
              .then(data => {
                this.languages = data;
                this.languages.sort((a, b) => {
                  return a.name.localeCompare(b.name);
                });
              })
              .catch(err => {
                console.error(err);
              });
          },
          initManagers() {
            fetch('./data/managers.json')
              .then(res => res.json())
              .then(data => {
                this.managers = data;
                this.managers.sort((a, b) => {
                  return a.name.localeCompare(b.name);
                });
              })
              .catch(err => {
                console.error(err);
              });
          },
          shouldShow(data) {
            return data.name.toLowerCase().includes(this.search.toLowerCase()) &&
              (
                this.shadow.$(`#language s-chip[language=all]`).attr('checked') === 'true' ||
                data.languages.some(lang => {
                  return this.shadow.$(`#language s-chip[language='${lang}']`).attr('checked') === 'true';
                })
              );
          },
          clearSearch(e) {
            const search = $(e.target).root.$('#search');
            search.ele.value = '';
            this.search = '';
          },
          openlink(e, url) {
            e.preventDefault();
            window.open(url, '_blank');
          }
        },
      };
    };
  </script>
</template>